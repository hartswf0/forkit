<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>FORK CASCADE ‚Äî Mobile Instrument</title>
    <style>
        :root {
            --transition: cubic-bezier(0.2, 0.8, 0.2, 1);
            --bg: #050507;
            --panel: rgba(28, 12, 18, 0.96);
            --panel-dark: rgba(12, 6, 8, 0.98);
            --border: #2f121a;
            --border-light: #4a1924;
            --text: #f6f2ef;
            --text-muted: #d3cdc9;
            --accent: #ff3d4e;
            --accent-soft: rgba(255, 61, 78, 0.15);
            --accent-glow: rgba(255, 61, 78, 0.4);
            --trackA: #56ff9f;
            /* Protocol */
            --trackB: #ff3d4e;
            /* Risk */
            --junction: #f8d66a;
            --font-mono: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", monospace;
            --font-serif: "Georgia", serif;
            --header-height: 48px;
            --bottom-nav-height: 64px;
            --safe-bottom: env(safe-area-inset-bottom);

            --toast-bg: rgba(0, 0, 0, 0.65);
            --shadow: 0 12px 50px rgba(0, 0, 0, 0.55);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-mono);
            font-size: 12px;
            -webkit-font-smoothing: antialiased;
        }

        svg {
            pointer-events: none;
        }

        .icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .app-shell {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            transition: all 0.3s var(--transition);
        }

        body.zen-mode .top-bar {
            transform: translateY(-100%);
        }

        body.zen-mode .bottom-nav {
            transform: translateY(100%);
        }

        body.zen-mode .zoom-controls {
            bottom: 20px;
        }

        body.zen-mode #viz-container {
            padding-bottom: 0;
        }

        body.zen-mode .zen-toggle {
            opacity: 1;
            pointer-events: auto;
        }

        .zen-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 120;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-muted);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .sidebar {
            width: 280px;
            background: var(--panel-dark);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 80;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            transition: transform 0.3s var(--transition);
            box-shadow: 20px 0 50px rgba(0, 0, 0, 0.5);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            height: var(--header-height);
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--panel);
            flex-shrink: 0;
        }

        .sys-title {
            font-weight: 900;
            font-size: 10px;
            letter-spacing: .18em;
            color: var(--text-muted);
        }

        .list-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:active {
            background: var(--accent-soft);
        }

        .list-item.active {
            background: var(--accent-soft);
            border-left: 4px solid var(--accent);
        }

        .list-item strong {
            display: block;
            font-size: 12px;
            letter-spacing: .06em;
        }

        .list-item .meta {
            margin-top: 6px;
            font-size: 10px;
            color: var(--text-muted);
            opacity: .85;
        }

        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        .top-bar {
            min-height: var(--header-height);
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 8px;
            z-index: 70;
            flex-shrink: 0;
            justify-content: space-between;
            transition: transform 0.3s var(--transition);
        }

        .mobile-toggle {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .mobile-toggle:active {
            background: var(--accent-soft);
            color: var(--accent);
            border-color: var(--accent);
        }

        .ring-container {
            flex: 1;
            display: flex;
            align-items: center;
            overflow: hidden;
            height: 100%;
            mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent);
        }

        .ring-bar {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 0 10px;
            align-items: center;
            scrollbar-width: none;
        }

        .ring-bar::-webkit-scrollbar {
            display: none;
        }

        .ring-node {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            opacity: 0.28;
            transition: all 0.3s var(--transition);
            flex-shrink: 0;
            cursor: pointer;
        }

        .ring-node.active {
            width: 10px;
            height: 10px;
            background: var(--accent);
            opacity: 1;
            box-shadow: 0 0 8px var(--accent);
        }

        #viz-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            cursor: grab;
            touch-action: none;
            background-color: var(--bg);
        }

        #viz-container:active {
            cursor: grabbing;
        }

        #viz-scale-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            min-width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            transition: transform 0.08s linear;
            will-change: transform;
        }

        .zoomed-out .node-label,
        .zoomed-out .node-meta,
        .zoomed-out .node-header {
            display: none;
        }

        .zoomed-out .tree-node {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            display: flex;
        }

        .zoomed-out .node-wrapper {
            margin: 0 4px;
        }

        .zoomed-out .children-row {
            margin-top: 30px;
            gap: 10px;
        }

        #svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        #reader-view {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px;
            background: var(--bg);
            max-width: 680px;
            margin: 0 auto;
            width: 100%;
            z-index: 10;
        }

        .reader-entry {
            border-left: 2px solid var(--border-light);
            padding-left: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .reader-entry::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 0;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .reader-entry.active::before {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .reader-label {
            font-weight: 700;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .reader-meta {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.1em;
        }

        .reader-text {
            font-family: var(--font-serif);
            font-size: 16px;
            line-height: 1.6;
            color: #ddd;
        }

        .instrument-panel {
            width: 320px;
            background: var(--panel-dark);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 90;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            transform: translateX(100%);
            transition: transform 0.3s var(--transition);
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.5);
        }

        .instrument-panel.open {
            transform: translateX(0);
        }

        .zoom-controls {
            position: absolute;
            bottom: calc(var(--bottom-nav-height) + 20px);
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 65;
            transition: transform 0.3s var(--transition);
        }

        .zoom-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--panel);
            border: 1px solid var(--border-light);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .zoom-btn:active {
            transform: scale(0.95);
            background: var(--accent);
            color: #fff;
        }

        .bottom-nav {
            height: var(--bottom-nav-height);
            background: rgba(18, 8, 12, 0.95);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 95;
            padding-bottom: var(--safe-bottom);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            backdrop-filter: blur(12px);
            transition: transform 0.3s var(--transition);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 0;
            width: 64px;
            height: 100%;
            opacity: 0.6;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--accent);
            opacity: 1;
        }

        .nav-item svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        .tree-node {
            background: var(--panel);
            border: 1px solid var(--border-light);
            padding: 16px;
            border-radius: 8px;
            width: 260px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 5;
            margin-bottom: 24px;
            backdrop-filter: blur(4px);
            user-select: none;
        }

        .tree-node:active {
            transform: scale(0.96);
        }

        .tree-node.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-soft), 0 8px 30px rgba(0, 0, 0, 0.6);
            background: linear-gradient(to bottom right, var(--panel), rgba(255, 61, 78, 0.08));
        }

        .tree-node.dimmed {
            opacity: 0.14;
            filter: grayscale(100%);
        }

        .node-fold-btn {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            background: var(--panel-dark);
            border: 1px solid var(--accent);
            border-radius: 50%;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        .children-row {
            transition: all 0.3s ease;
            transform-origin: top center;
        }

        .children-row.hidden {
            display: none !important;
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .node-label {
            font-size: 14px;
            font-weight: 800;
            color: var(--text);
            line-height: 1.25;
        }

        .node-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 8px;
        }

        .node-safe {
            border-left: 4px solid var(--trackA);
        }

        .node-danger {
            border-left: 4px solid var(--trackB);
        }

        .node-root {
            border-left: 4px solid var(--junction);
        }

        .btn {
            background: var(--panel-dark);
            border: 1px solid var(--border-light);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--text);
            margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .instrument-panel {
                width: 100%;
                height: 80vh;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                transform: translateY(100%);
                border-left: none;
                border-top: 1px solid var(--accent);
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.6);
            }

            .instrument-panel.open {
                transform: translateY(0);
            }

            .tree-node {
                width: 80vw;
                max-width: 320px;
            }

            .desktop-only {
                display: none !important;
            }

            .zoomed-out .tree-node {
                width: 32px;
                height: 32px;
            }
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 150;
            padding: 20px;
        }

        .overlay.active {
            display: flex;
        }

        .manual-page {
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            background: #fff;
            color: #000;
            padding: 0;
            box-shadow: 0 20px 50px #000;
            font-family: 'Georgia', serif;
            border-radius: 4px;
        }

        /* NEW: Toast + tiny status */
        .toast {
            position: fixed;
            left: 50%;
            bottom: calc(var(--bottom-nav-height) + var(--safe-bottom) + 18px);
            transform: translateX(-50%);
            background: var(--toast-bg);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 10px 12px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            font-size: 11px;
            letter-spacing: .06em;
            opacity: 0;
            pointer-events: none;
            transition: opacity .22s var(--transition), transform .22s var(--transition);
            z-index: 140;
            max-width: min(520px, 90vw);
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        /* NEW: Screen dimmer when drawers open (tap to close) */
        .scrim {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            z-index: 75;
        }

        .scrim.active {
            display: block;
        }

        /* NEW: subtle header meta */
        #dilemma-header {
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.45);
        }

        /* ‚ïê‚ïê‚ïê CASCADE MINIMAP ‚ïê‚ïê‚ïê */
        .cascade-map-toggle {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 100;
            background: var(--panel);
            border: 1px solid var(--border-light);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cascade-map-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .cascade-minimap {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 280px;
            max-height: 60vh;
            background: rgba(20, 10, 14, 0.98);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            z-index: 99;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .cascade-minimap.open {
            display: flex;
        }

        .cascade-map-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 10px;
            letter-spacing: 0.15em;
            color: var(--accent);
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cascade-map-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
        }

        .cascade-map-body {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }

        .map-tree {
            position: relative;
        }

        .map-node {
            position: relative;
            padding: 6px 10px;
            margin: 4px 0;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 10px;
            font-family: var(--font-mono);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-node:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .map-node.current {
            background: var(--accent-soft);
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .map-node.visited {
            border-left: 3px solid var(--trackA);
        }

        .map-node.terminal {
            border-left: 3px solid var(--junction);
            background: rgba(248, 214, 106, 0.1);
        }

        .map-node-icon {
            font-size: 12px;
        }

        .map-node-id {
            font-weight: 700;
            color: var(--text);
        }

        .map-node-label {
            flex: 1;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .map-node-prob {
            font-size: 9px;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 8px;
        }

        .map-children {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px dashed var(--border);
        }

        .fork-badge {
            font-size: 8px;
            background: var(--trackA);
            color: #000;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 900;
        }

        .map-legend {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 16px;
            font-size: 9px;
            color: var(--text-muted);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.current {
            background: var(--accent);
        }

        .legend-dot.visited {
            background: var(--trackA);
        }

        .legend-dot.terminal {
            background: var(--junction);
        }

        /* ‚ïê‚ïê‚ïê RAILS MODE ‚ïê‚ïê‚ïê */
        .rails-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.95));
            padding: 20px 24px 24px;
            z-index: 150;
            display: none;
            flex-direction: column;
            gap: 12px;
        }

        .rails-bar.active {
            display: flex;
        }

        .rails-logline {
            font-size: 18px;
            font-family: var(--font-serif);
            color: var(--text);
            text-align: center;
            line-height: 1.5;
            max-width: 600px;
            margin: 0 auto;
        }

        .rails-progress-wrap {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .rails-progress {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .rails-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--trackA), var(--accent));
            transition: width 0.5s;
        }

        .rails-step {
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 0.1em;
            min-width: 80px;
            text-align: right;
        }

        .rails-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .rails-btn {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            font-size: 11px;
            letter-spacing: 0.1em;
            cursor: pointer;
            border-radius: 4px;
        }

        .rails-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .rails-btn.primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .rails-toggle {
            position: fixed;
            top: 60px;
            right: 170px;
            z-index: 100;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.15em;
            cursor: pointer;
        }

        .rails-toggle:hover {
            border-color: var(--text);
            color: var(--text);
        }

        .rails-toggle.active {
            border-color: var(--trackA);
            color: var(--trackA);
        }

        /* ‚ïê‚ïê‚ïê LEGO BLOCKS ‚Äî FORK CARDS ‚ïê‚ïê‚ïê */
        .fork-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 16px 0;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 2px solid var(--trackA);
        }

        .fork-block {
            background: var(--trackA);
            color: #000;
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 900;
            letter-spacing: 0.05em;
            padding: 14px 20px;
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.25s;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 140px;
        }

        .fork-block .fork-id {
            font-size: 14px;
            font-weight: 900;
        }

        .fork-block .fork-desc {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
            line-height: 1.4;
        }

        .fork-block::before,
        .fork-block::after {
            content: '';
            position: absolute;
            top: -6px;
            width: 10px;
            height: 6px;
            background: inherit;
            filter: brightness(1.3);
        }

        .fork-block::before {
            left: 10px;
        }

        .fork-block::after {
            left: 26px;
        }

        .fork-block:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 24px rgba(86, 255, 159, 0.5);
        }

        .section-label {
            font-size: 10px;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .section-label.green {
            color: var(--trackA);
        }

        .decision-banner {
            background: linear-gradient(90deg, rgba(86, 255, 159, 0.1), transparent);
            border-left: 3px solid var(--trackA);
            padding: 16px 20px;
            margin: 16px 0;
        }

        .decision-title {
            font-size: 10px;
            letter-spacing: 0.2em;
            color: var(--trackA);
            margin-bottom: 8px;
        }

        .decision-actor {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        @media (max-width: 768px) {
            .fork-grid {
                flex-direction: column;
                padding: 12px;
            }

            .fork-block {
                width: 100%;
                min-height: 60px;
                padding: 16px 20px;
            }

            .fork-block .fork-id {
                font-size: 16px;
            }
        }

        /* ‚ïê‚ïê‚ïê MEDIA NEXUS ‚ïê‚ïê‚ïê */
        .media-nexus {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .media-nexus.single {
            grid-template-columns: 1fr;
        }

        .media-item {
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
        }

        .media-item:hover {
            border-color: var(--text-muted);
            transform: scale(1.02);
        }

        .media-item.image img {
            width: 100%;
            height: auto;
            display: block;
        }

        .media-item.video video {
            width: 100%;
            display: block;
        }

        .media-item.embed iframe {
            width: 100%;
            min-height: 200px;
            border: none;
        }

        .media-item.three {
            min-height: 300px;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-item.icon {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .media-caption {
            padding: 8px 12px;
            font-size: 10px;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>

    <button class="zen-toggle" id="btn-zen-exit" onclick="toggleZenMode()" aria-label="Exit Zen">‚úï</button>
    <div class="scrim" id="scrim" onclick="closeAllPanels()"></div>
    <div class="toast" id="toast"></div>

    <!-- MAP & FOCUS -->
    <button class="cascade-map-toggle" onclick="toggleCascadeMap()">MAP</button>
    <button class="cascade-map-toggle" style="right:90px;" onclick="toggleFocusMode()">FOCUS</button>
    <div class="cascade-minimap" id="cascadeMap">
        <div class="cascade-map-header">
            <span>CASCADE TREE</span>
            <button class="cascade-map-close" onclick="toggleCascadeMap()">√ó</button>
        </div>
        <div class="cascade-map-body" id="cascadeMapBody">
            <div style="color:var(--text-muted); text-align:center; padding:20px;">Select a scenario</div>
        </div>
        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-dot current"></div> Current
            </div>
            <div class="legend-item">
                <div class="legend-dot visited"></div> Visited
            </div>
            <div class="legend-item">
                <div class="legend-dot terminal"></div> Terminal
            </div>
        </div>
    </div>

    <div class="app-shell">

        <!-- LEFT DRAWER -->
        <div class="sidebar" id="sidebar" aria-label="Scenario Index">
            <div class="sidebar-header">
                <div class="sys-title">SYSTEM INDEX</div>
                <button class="mobile-toggle" style="width:30px; height:30px;" onclick="toggleSidebar(false)"
                    aria-label="Close Index">‚úï</button>
            </div>
            <div id="scenario-list" style="overflow-y: auto; flex: 1;"></div>
        </div>

        <!-- MAIN STAGE -->
        <div class="main-view">
            <!-- Top Bar -->
            <div class="top-bar" id="top-bar">
                <button class="mobile-toggle" id="btn-menu" title="Menu" onclick="toggleSidebar(true)"
                    style="background:transparent; border:1px solid var(--border-light); color:var(--accent); width:32px; height:32px; border-radius:4px; display:none;"
                    aria-label="Open Index">‚ò∞</button>

                <div style="font-weight:900; font-size:12px; letter-spacing:0.1em; color:var(--accent);">FORK CASCADE
                </div>

                <div class="ring-container" id="ring-container" title="Tap dots to restore path">
                    <div class="ring-bar" id="ring-bar" aria-label="Ring Memory"></div>
                </div>

                <div class="desktop-only" style="display:flex; gap:8px;">
                    <button class="btn" id="btn-zen" onclick="toggleZenMode()">ZEN</button>
                    <button class="btn" id="btn-play-desktop">‚ñ∂ GHOST</button>
                    <button class="btn" id="btn-reset-desktop">RESET</button>
                </div>
            </div>

            <!-- Views -->
            <div id="viz-container" aria-label="Graph View">
                <div id="viz-scale-wrapper">
                    <svg id="svg-layer"></svg>
                    <div id="dilemma-header"
                        style="width:100%; max-width:600px; background:var(--panel); border:1px solid var(--border); padding:20px; border-radius:4px; margin-bottom:40px; display:none; z-index:5;">
                    </div>
                    <div id="tree-root"
                        style="display:flex; flex-direction:column; align-items:center; width:100%; position:relative; z-index:2;">
                    </div>
                </div>
            </div>

            <!-- Reader View -->
            <div id="reader-view" aria-label="Reader View"></div>

            <!-- Zoom Controls -->
            <div class="zoom-controls" id="zoom-controls" aria-label="Zoom Controls">
                <button class="zoom-btn" onclick="changeZoom(0.2)" aria-label="Zoom In">+</button>
                <button class="zoom-btn" onclick="changeZoom(-0.2)" aria-label="Zoom Out">‚àí</button>
                <button class="zoom-btn" style="font-size:12px; font-weight:bold;" onclick="toggleZenMode()"
                    aria-label="Zen Mode">ZEN</button>
            </div>

            <!-- Bottom Nav -->
            <nav class="bottom-nav" aria-label="Bottom Navigation">
                <button class="nav-item" id="nav-index" onclick="toggleSidebar(true)">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                    </svg>
                    <span>INDEX</span>
                </button>

                <button class="nav-item" id="btn-view-toggle" onclick="toggleViewMode()">
                    <svg id="icon-view-tree" viewBox="0 0 24 24">
                        <path d="M22 11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3z" />
                    </svg>
                    <span id="label-view-toggle">FOCUS</span>
                </button>

                <button class="nav-item" id="btn-play-mobile">
                    <svg viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    <span>PLAY</span>
                </button>

                <button class="nav-item" id="nav-data" onclick="toggleInstrument()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                    </svg>
                    <span>DATA</span>
                </button>
            </nav>
        </div>

        <!-- RIGHT/BOTTOM DRAWER: INSTRUMENT -->
        <div class="instrument-panel" id="instrument-panel" aria-label="Instrument Panel">
            <div class="sidebar-header" style="justify-content:center; position:relative;">
                <div
                    style="width:40px; height:4px; background:var(--border-light); border-radius:2px; position:absolute; top:8px;">
                </div>
                <div class="sys-title" style="margin-top:10px;">MORAL GENOME</div>
                <button class="mobile-toggle"
                    style="position:absolute; right:16px; top:12px; width:30px; height:30px; border:none;"
                    onclick="toggleInstrument()" aria-label="Close Data">‚úï</button>
            </div>

            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                <div style="margin-bottom: 10px; color: var(--text-muted); font-size: 10px; letter-spacing:.16em;">
                    <span id="instrument-scn">‚Äî</span>
                </div>

                <!-- Sliders -->
                <div style="margin-bottom: 30px;">
                    <div
                        style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:10px; font-weight:bold;">
                        <span style="color:var(--trackA)">PROTOCOL RIGIDITY</span>
                        <span id="val-proto">50%</span>
                    </div>
                    <input type="range" id="slider-proto" min="0" max="100" value="50" aria-label="Protocol Rigidity">
                </div>

                <div style="margin-bottom: 30px;">
                    <div
                        style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:10px; font-weight:bold;">
                        <span style="color:var(--trackB)">HUMAN COST TOLERANCE</span>
                        <span id="val-risk">50%</span>
                    </div>
                    <input type="range" id="slider-risk" min="0" max="100" value="50" aria-label="Human Cost Tolerance">
                </div>

                <!-- Radar -->
                <div
                    style="background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:10px; height:200px; margin-bottom:20px;">
                    <canvas id="radar" style="width:100%; height:100%;"></canvas>
                </div>

                <div id="genome-metrics" style="margin-top:16px; display:grid; grid-template-columns: 1fr; gap:12px;">
                </div>

                <button class="btn" style="width:100%; padding:16px; margin-top:24px;" id="btn-manual">OPEN SERVICE
                    RECORD</button>
                <button class="btn"
                    style="width:100%; padding:16px; margin-top:12px; border-color:var(--text-muted); color:var(--text-muted);"
                    id="btn-reset-mobile">RESET SIMULATION</button>

                <div style="margin-top:18px; opacity:.85;">
                    <!-- LEGOS OVERLAY BUTTONS -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                        <button class="btn" style="padding:12px;" onclick="openRingOverlay()">üî¥ RING</button>
                        <button class="btn" style="padding:12px;" onclick="openSnapshotsOverlay()">üì∏ SHOTS</button>
                        <button class="btn" style="padding:12px;" onclick="openKeysOverlay()">üîë KEYS</button>
                        <button class="btn" style="padding:12px;" onclick="openTetradOverlay()">üî∑ TETRAD</button>
                    </div>
                    <button class="btn" style="width:100%;padding:12px;margin-bottom:8px;" onclick="openGridOverlay()">‚¨õ
                        GRID BINDINGS</button>

                    <button class="btn" style="width:100%; padding:14px;" id="btn-export">EXPORT SESSION</button>
                    <button class="btn" style="width:100%; padding:14px; margin-top:10px;" id="btn-import">IMPORT
                        SESSION</button>
                    <input id="file-import" type="file" accept="application/json" style="display:none;" />
                </div>
            </div>
        </div>

    </div>

    <!-- OVERLAY: MANUAL -->
    <div class="overlay" id="manual-overlay" aria-label="Manual Overlay">
        <div class="manual-page" id="manual-content"></div>
    </div>

    <!-- OVERLAY: RING MEMORY -->
    <div class="overlay" id="ring-overlay" aria-label="Ring Memory Overlay">
        <div class="manual-page" style="background:var(--panel-dark);color:var(--text);max-width:400px;">
            <div style="padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div class="sys-title">RING MEMORY ‚Äî 12 SLOTS</div>
                    <button class="btn" onclick="closeOverlay('ring-overlay')">‚úï</button>
                </div>
                <div id="ring-slots" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;"></div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: SNAPSHOTS -->
    <div class="overlay" id="snapshots-overlay" aria-label="Snapshots Overlay">
        <div class="manual-page" style="background:var(--panel-dark);color:var(--text);max-width:500px;">
            <div style="padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div class="sys-title">SNAPSHOTS (max 20)</div>
                    <button class="btn" onclick="closeOverlay('snapshots-overlay')">‚úï</button>
                </div>
                <div id="snapshots-list" style="max-height:400px;overflow-y:auto;"></div>
                <button class="btn btn-primary" style="width:100%;margin-top:16px;" onclick="saveSnapshot()">SAVE
                    SNAPSHOT</button>
            </div>
        </div>
    </div>

    <!-- OVERLAY: KEYSTORE -->
    <div class="overlay" id="keys-overlay" aria-label="KeyStore Overlay">
        <div class="manual-page" style="background:var(--panel-dark);color:var(--text);max-width:450px;">
            <div style="padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div class="sys-title">KEY STORE</div>
                    <button class="btn" onclick="closeOverlay('keys-overlay')">‚úï</button>
                </div>
                <div style="margin-bottom:16px;">
                    <input id="key-name" placeholder="key_name"
                        style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:4px;margin-bottom:8px;">
                    <textarea id="key-value" placeholder="value (max 4KB)" rows="3"
                        style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:4px;resize:none;"></textarea>
                    <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="createKey()">ADD
                        KEY</button>
                </div>
                <div id="keys-list" style="max-height:250px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: PERSPECTIVE (TETRAD) -->
    <div class="overlay" id="tetrad-overlay" aria-label="Tetrad Perspective Overlay">
        <div class="manual-page" style="background:var(--panel-dark);color:var(--text);max-width:360px;">
            <div style="padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div class="sys-title">MCLUHAN TETRAD LENS</div>
                    <button class="btn" onclick="closeOverlay('tetrad-overlay')">‚úï</button>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <button class="btn tetrad-btn" data-lens="enhance" onclick="selectLens('enhance')"
                        style="padding:20px;text-align:center;">
                        <div style="font-size:20px;margin-bottom:6px;">‚¨ÜÔ∏è</div>
                        <div style="font-weight:bold;">ENHANCE</div>
                        <div style="font-size:9px;color:var(--text-muted);margin-top:4px;">What does it amplify?</div>
                    </button>
                    <button class="btn tetrad-btn" data-lens="obsolesce" onclick="selectLens('obsolesce')"
                        style="padding:20px;text-align:center;">
                        <div style="font-size:20px;margin-bottom:6px;">‚¨áÔ∏è</div>
                        <div style="font-weight:bold;">OBSOLESCE</div>
                        <div style="font-size:9px;color:var(--text-muted);margin-top:4px;">What does it push aside?
                        </div>
                    </button>
                    <button class="btn tetrad-btn" data-lens="retrieve" onclick="selectLens('retrieve')"
                        style="padding:20px;text-align:center;">
                        <div style="font-size:20px;margin-bottom:6px;">üîÑ</div>
                        <div style="font-weight:bold;">RETRIEVE</div>
                        <div style="font-size:9px;color:var(--text-muted);margin-top:4px;">What does it bring back?
                        </div>
                    </button>
                    <button class="btn tetrad-btn" data-lens="reverse" onclick="selectLens('reverse')"
                        style="padding:20px;text-align:center;">
                        <div style="font-size:20px;margin-bottom:6px;">üîÉ</div>
                        <div style="font-weight:bold;">REVERSE</div>
                        <div style="font-size:9px;color:var(--text-muted);margin-top:4px;">What does it flip into?</div>
                    </button>
                </div>
                <div id="current-lens" style="margin-top:16px;text-align:center;color:var(--accent);font-weight:bold;">
                    CURRENT: ENHANCE</div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: GRID SECTION -->
    <div class="overlay" id="grid-overlay" aria-label="Grid Overlay">
        <div class="manual-page" style="background:var(--panel-dark);color:var(--text);max-width:400px;">
            <div style="padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div class="sys-title">9√ó9 GRID BINDINGS</div>
                    <button class="btn" onclick="closeOverlay('grid-overlay')">‚úï</button>
                </div>
                <div id="grid-section" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;"></div>
                <div style="margin-top:16px;font-size:10px;color:var(--text-muted);">Tap cell to bind current node.
                    Long-press to unbind.</div>
            </div>
        </div>
    </div>

    <script>
        /* ------------------------------------------------------------------
           MOBILE MENU BUTTON SHOW/HIDE
           ------------------------------------------------------------------ */
        (function () {
            const btn = document.getElementById('btn-menu');
            const update = () => btn.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';
            update();
            window.addEventListener('resize', update);
        })();

        /* ------------------------------------------------------------------
           DATA & STATE ‚Äî Now loads from thick_data.json
           ------------------------------------------------------------------ */
        let SCENARIOS = [];

        function transformThickData(thickData) {
            return thickData.map(scenario => {
                const nodes = (scenario.branches || []).map(branch => {
                    let type = 'safe';
                    if (branch.terminal_state) type = 'terminal';
                    else if (branch.probability < 0.5) type = 'danger';
                    return {
                        id: branch.branch_id,
                        label: branch.label || branch.branch_id,
                        prob: branch.probability || 0.5,
                        depth: branch.depth,
                        meta: branch.immediate_consequence?.substring(0, 50) || branch.time_elapsed || '',
                        type: type,
                        branches: branch.branches || [],
                        monologue: branch.thick_description?.internal_monologue || branch.thick_description?.what_he_says || '',
                        thickData: branch.thick_description
                    };
                });
                const root = scenario.root ? {
                    id: scenario.root.branch_id || 'R0',
                    label: scenario.root.label || scenario.title,
                    prob: scenario.root.probability || 1.0,
                    depth: 0,
                    meta: scenario.root.timestamp || '',
                    branches: scenario.root.branches || [],
                    monologue: scenario.root.thick_description?.internal_monologue || scenario.root.thick_description?.setting || '',
                    thickData: scenario.root.thick_description
                } : { id: 'R0', label: scenario.title, prob: 1.0, depth: 0, meta: '', branches: [], monologue: '' };
                return { id: scenario.scenario_id, title: scenario.title, root, nodes };
            });
        }

        const FALLBACK_SCENARIOS = [
            {
                id: "SCN_089", title: "REACTOR CASCADE",
                root: { id: "R0", label: "COOLANT VALVE FAILURE", prob: 1.0, depth: 0, meta: "SECTOR 7 GEOTHERMAL", branches: ["B1", "B2"], monologue: "Sensors spike." },
                nodes: [
                    { id: "B1", label: "EMERGENCY VENT", prob: 0.6, meta: "12 CASUALTIES", type: "safe", branches: [] },
                    { id: "B2", label: "ATTEMPT CONTAINMENT", prob: 0.4, meta: "HIGH RISK", type: "danger", branches: [] }
                ]
            }
        ];

        async function loadThickData() {
            try {
                const response = await fetch('thick_data.json');
                const data = await response.json();
                SCENARIOS = transformThickData(data.ALL_THICK_DATA || data);
                console.log('[BON-03] Loaded', SCENARIOS.length, 'scenarios');
            } catch (err) {
                console.warn('[BON-03] Using fallback:', err);
                SCENARIOS = FALLBACK_SCENARIOS;
            }
        }

        const METRICS = ["authority", "logic", "empathy", "risk", "uncertainty"];

        // LocalStorage strict keys (v1)
        const LS = {
            SESSION: "LEGOS_TETRAD_SESSION_v1",
            RING: "LEGOS_TETRAD_RING_v1",
            SNAP: "LEGOS_TETRAD_SNAPSHOTS_v1"
        };

        // Ring: fixed 12 slots of node IDs (in this simplified build)
        const DEFAULT_RING = { schema_version: "v1", slots: Array.from({ length: 12 }, (_, i) => ({ index: i, nodeRef: null, label: null, pinned: false, updated_at: new Date().toISOString() })) };

        let state = {
            currentScenario: 0,
            zoom: 1.0,
            viewMode: 'focus', // focus | map | reader
            metrics: { authority: 2.5, logic: 2.5, empathy: 2.5, risk: 2.5, uncertainty: 2.5 },
            mix: { protocol: 50, risk: 50 },
            simulating: false,
            history: [],             // [{scenarioIndex,nodeId,at}]
            pan: { x: 0, y: 0 },
            foldedNodes: new Set(),
            zenMode: false,
            ring: safeLoadJSON(LS.RING, DEFAULT_RING),
            lastActiveNodeId: null,
            sessionId: 'SESSION_' + Math.random().toString(16).slice(2, 10).toUpperCase(),
            // LEGOS spec additions:
            tetradState: {
                activeLens: 'enhance',
                lensPerChannel: {},
                overlayOpen: false
            },
            gridState: {
                enabled: true,
                collapsed: false,
                mode: 'macro3x3',
                activeCell: null,
                bindings: []
            },
            keyStore: safeLoadJSON('LEGOS_TETRAD_KEYS_v1', { schema_version: 'v1', keys: [] }),
            snapshots: safeLoadJSON(LS.SNAP, [])
        };

        /* ------------------------------------------------------------------
           UTIL
           ------------------------------------------------------------------ */
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        function toast(msg, ms = 1200) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.classList.add('show');
            clearTimeout(toast._t);
            toast._t = setTimeout(() => el.classList.remove('show'), ms);
        }

        function safeLoadJSON(key, fallback) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return fallback;
                const parsed = JSON.parse(raw);
                return parsed ?? fallback;
            } catch (e) {
                return fallback;
            }
        }

        function safeSaveJSON(key, val) {
            try {
                localStorage.setItem(key, JSON.stringify(val));
                return true;
            } catch (e) {
                toast("STORAGE FAIL ‚Äî EXPORT RECOMMENDED", 1600);
                return false;
            }
        }

        function nowISO() { return new Date().toISOString(); }

        function closeAllPanels() {
            document.getElementById('sidebar')?.classList.remove('open');
            document.getElementById('instrument-panel')?.classList.remove('open');
            updateScrim();
        }

        function updateScrim() {
            const scrim = document.getElementById('scrim');
            const open = document.getElementById('sidebar')?.classList.contains('open') ||
                document.getElementById('instrument-panel')?.classList.contains('open');
            scrim.classList.toggle('active', !!open);
        }

        /* ------------------------------------------------------------------
           INIT
           ------------------------------------------------------------------ */
        async function init() {
            await loadThickData();
            renderSidebar();
            hydrateSession();
            loadScenario(state.currentScenario);
            setupListeners();
            setupTouchPanZoom();
            requestAnimationFrame(drawLines);
            window.addEventListener('resize', () => requestAnimationFrame(drawLines));
        }

        function hydrateSession() {
            const sess = safeLoadJSON(LS.SESSION, null);
            if (!sess) return;
            if (typeof sess.currentScenario === "number") state.currentScenario = clamp(sess.currentScenario, 0, SCENARIOS.length - 1);
            if (sess.mix && typeof sess.mix.protocol === "number" && typeof sess.mix.risk === "number") {
                state.mix.protocol = clamp(sess.mix.protocol, 0, 100);
                state.mix.risk = clamp(sess.mix.risk, 0, 100);
            }
            if (sess.viewMode) state.viewMode = sess.viewMode;
            if (sess.zoom) state.zoom = clamp(sess.zoom, 0.2, 2.5);
            if (sess.zenMode) state.zenMode = !!sess.zenMode;
            if (sess.lastActiveNodeId) state.lastActiveNodeId = sess.lastActiveNodeId;
        }

        function persistSession() {
            safeSaveJSON(LS.SESSION, {
                schema_version: "v1",
                saved_at: nowISO(),
                currentScenario: state.currentScenario,
                mix: state.mix,
                viewMode: state.viewMode,
                zoom: state.zoom,
                zenMode: state.zenMode,
                lastActiveNodeId: state.lastActiveNodeId
            });
        }

        // ‚ïê‚ïê‚ïê CASCADE MAP FUNCTIONS ‚ïê‚ïê‚ïê
        let cascadeMapOpen = false;
        let visitedBranches = new Set();
        let focusModeActive = false;

        function toggleFocusMode() {
            focusModeActive = !focusModeActive;
            if (focusModeActive) {
                const content = document.getElementById('thick-panel')?.innerHTML || document.querySelector('.thick-panel')?.innerHTML || '';
                alert('Focus mode: View thick content in clean overlay. (Full implementation pending thick-panel container)');
            }
        }

        function toggleCascadeMap() {
            cascadeMapOpen = !cascadeMapOpen;
            document.getElementById('cascadeMap').classList.toggle('open', cascadeMapOpen);
            if (cascadeMapOpen) renderCascadeMap();
        }

        function renderCascadeMap() {
            const body = document.getElementById('cascadeMapBody');
            const scn = SCENARIOS[state.currentScenario];
            if (!scn) { body.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">Select a scenario</div>'; return; }
            visitedBranches.add(state.lastActiveNodeId || scn.root?.id || 'R0');
            let html = '<div class="map-tree">' + renderMapNode(scn.root, scn, state.lastActiveNodeId || scn.root?.id, 0) + '</div>';
            body.innerHTML = html;
        }

        function renderMapNode(node, scn, currentId, depth) {
            if (!node) return '';
            const nodeId = node.id || 'R0';
            const isCurrent = nodeId === currentId, isVisited = visitedBranches.has(nodeId), isTerminal = !node.branches || node.branches.length === 0;
            let cls = 'map-node'; if (isCurrent) cls += ' current'; else if (isVisited) cls += ' visited'; if (isTerminal && depth > 0) cls += ' terminal';
            const icon = isTerminal && depth > 0 ? 'üîö' : (node.branches?.length > 0 ? '‚éá' : '‚óã');
            const prob = node.prob ? Math.round(node.prob * 100) + '%' : '';
            const label = node.label || nodeId;
            let html = `<div class="${cls}" onclick="jumpToNode('${nodeId}')" title="${label}">
                <span class="map-node-icon">${icon}</span><span class="map-node-id">${nodeId}</span>
                <span class="map-node-label">${label.length > 20 ? label.substring(0, 20) + '...' : label}</span>
                ${prob ? `<span class="map-node-prob">${prob}</span>` : ''}${isCurrent ? '<span class="fork-badge">YOU</span>' : ''}
            </div>`;
            if (node.branches && node.branches.length > 0) {
                html += '<div class="map-children">';
                node.branches.forEach(branchId => { const child = scn.nodes?.find(n => n.id === branchId); if (child) html += renderMapNode(child, scn, currentId, depth + 1); });
                html += '</div>';
            }
            return html;
        }

        function jumpToNode(nodeId) {
            const scn = SCENARIOS[state.currentScenario]; if (!scn) return;
            let targetNode = scn.root?.id === nodeId ? scn.root : scn.nodes?.find(n => n.id === nodeId);
            if (targetNode) {
                const el = document.getElementById(`node-${nodeId}`);
                if (el) { activateNode(el, targetNode); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                visitedBranches.add(nodeId);
                if (cascadeMapOpen) renderCascadeMap();
            }
        }

        function loadScenario(index) {
            state.currentScenario = index;
            state.history = [];
            state.metrics = { authority: 2.5, logic: 2.5, empathy: 2.5, risk: 2.5, uncertainty: 2.5 };
            state.foldedNodes.clear();

            // Ring view: render from ring slots (persisted)
            renderRing();

            const scn = SCENARIOS[index];

            // Tree View
            const root = document.getElementById('tree-root');
            root.innerHTML = '';
            renderNode(scn.root, root);
            renderHeader(scn.root);

            // Reader View
            const reader = document.getElementById('reader-view');
            reader.innerHTML = '';
            addReaderEntry(scn.root);

            // Sliders & instrument
            syncSliders();
            updateInstrument();
            filterTree();

            // Close index on select
            document.getElementById('sidebar').classList.remove('open');
            updateScrim();

            // Highlight sidebar
            document.querySelectorAll('.list-item').forEach((el, i) => el.classList.toggle('active', i === index));

            // Apply zen mode state
            document.body.classList.toggle('zen-mode', !!state.zenMode);

            // Apply view mode state
            setViewMode(state.viewMode, { silent: true });

            // Restore lastActiveNode if it matches this scenario
            if (state.lastActiveNodeId) {
                const el = document.getElementById(`node-${state.lastActiveNodeId}`);
                if (el) {
                    const nodeData = lookupNodeById(state.lastActiveNodeId);
                    if (nodeData) activateNode(el, nodeData, { pushHistory: false, silentScroll: true });
                }
            }

            persistSession();
            requestAnimationFrame(drawLines);
            document.getElementById('instrument-scn').textContent = `${scn.id} ‚Äî ${scn.title}`;
        }

        function syncSliders() {
            const pSlider = document.getElementById('slider-proto');
            const rSlider = document.getElementById('slider-risk');
            if (pSlider) pSlider.value = String(state.mix.protocol);
            if (rSlider) rSlider.value = String(state.mix.risk);
            const vp = document.getElementById('val-proto'); if (vp) vp.textContent = state.mix.protocol + "%";
            const vr = document.getElementById('val-risk'); if (vr) vr.textContent = state.mix.risk + "%";
        }

        /* ------------------------------------------------------------------
           LOOKUPS
           ------------------------------------------------------------------ */
        function currentScenario() { return SCENARIOS[state.currentScenario]; }

        function lookupNodeById(id) {
            const scn = currentScenario();
            if (id === scn.root.id) return { ...scn.root, type: "root" };
            const found = scn.nodes.find(n => n.id === id);
            if (found) return found;
            return null;
        }

        function nodeDisplayMeta(node) {
            return node.meta || "";
        }

        /* ------------------------------------------------------------------
           VISUALIZATION
           ------------------------------------------------------------------ */
        function renderHeader(data) {
            const header = document.getElementById('dilemma-header');
            header.style.display = 'block';
            header.innerHTML = `
        <div style="font-size:10px; color:var(--accent); letter-spacing:0.2em; margin-bottom:6px; font-weight:900;">CURRENT VECTOR</div>
        <div style="font-size:16px; font-weight:bold; color:#fff; margin-bottom:4px;">${escapeHTML(data.label)}</div>
        <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">${escapeHTML(data.meta || "")}</div>
        ${data.monologue ? `<div style="font-style:italic; border-left:3px solid var(--accent); padding-left:12px; font-family:var(--font-serif); font-size:14px; color:#fff; line-height:1.5;">"${escapeHTML(data.monologue)}"</div>` : ''}
      `;
        }

        function renderNode(data, parentContainer) {
            const wrapper = document.createElement('div');
            wrapper.className = 'node-wrapper';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'center';
            wrapper.style.margin = '0 10px';
            wrapper.id = `wrapper-${data.id}`;

            const el = document.createElement('div');
            el.className = `tree-node ${data.type ? 'node-' + data.type : 'node-root'}`;
            el.id = `node-${data.id}`;
            el.dataset.label = data.label;

            const prob = (typeof data.prob === "number") ? data.prob : 1.0;

            el.innerHTML = `
        <div class="node-header">
          <span>${escapeHTML(data.id)}</span>
          <span>${(prob * 100).toFixed(0)}%</span>
        </div>
        <div class="node-label">${escapeHTML(data.label)}</div>
        ${data.meta ? `<div class="node-meta">‚ñ∑ ${escapeHTML(data.meta)}</div>` : ''}
      `;

            el.onclick = (e) => { e.stopPropagation(); activateNode(el, data, { pushHistory: true }); };

            wrapper.appendChild(el);

            if (data.branches && data.branches.length > 0) {
                // Fold button
                const foldBtn = document.createElement('div');
                foldBtn.className = 'node-fold-btn';
                foldBtn.innerHTML = state.foldedNodes.has(data.id) ? '+' : '‚àí';
                foldBtn.onclick = (e) => { e.stopPropagation(); toggleFold(data.id); };
                el.appendChild(foldBtn);

                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'children-row';
                childrenDiv.id = `children-${data.id}`;
                childrenDiv.style.display = 'flex';
                childrenDiv.style.marginTop = '50px';
                childrenDiv.style.gap = '20px';

                if (state.foldedNodes.has(data.id)) childrenDiv.classList.add('hidden');

                const scn = currentScenario();
                data.branches.forEach(branchId => {
                    const branchData = (branchId === scn.root.id) ? scn.root : scn.nodes.find(n => n.id === branchId);
                    if (branchData) renderNode(branchData, childrenDiv);
                });
                wrapper.appendChild(childrenDiv);
            }

            parentContainer.appendChild(wrapper);
            requestAnimationFrame(drawLines);
        }

        function toggleFold(nodeId) {
            if (state.foldedNodes.has(nodeId)) state.foldedNodes.delete(nodeId);
            else state.foldedNodes.add(nodeId);

            const scn = currentScenario();
            const root = document.getElementById('tree-root');
            root.innerHTML = '';
            renderNode(scn.root, root);

            // keep active highlight if possible
            if (state.lastActiveNodeId) {
                const activeEl = document.getElementById(`node-${state.lastActiveNodeId}`);
                if (activeEl) activeEl.classList.add('active');
            }

            filterTree();
            requestAnimationFrame(drawLines);
        }

        function addReaderEntry(data) {
            const reader = document.getElementById('reader-view');
            const entry = document.createElement('div');
            entry.className = 'reader-entry';
            entry.id = `reader-${data.id}`;
            entry.innerHTML = `
        <div class="reader-label">${escapeHTML(data.label)}</div>
        <div class="reader-meta">${escapeHTML(data.meta || "")}</div>
        ${data.monologue ? `<div class="reader-text">"${escapeHTML(data.monologue)}"</div>` : ''}
      `;
            reader.appendChild(entry);
        }

        function activateNode(el, data, opts = { pushHistory: true, silentScroll: false }) {
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
            el.classList.add('active');

            // Update header to active node
            renderHeader(data);

            // Reader highlight
            document.querySelectorAll('.reader-entry').forEach(n => n.classList.remove('active'));
            const rEl = document.getElementById(`reader-${data.id}`);
            if (rEl) rEl.classList.add('active');
            else addReaderEntry(data);

            // Update metrics & history
            updateMetrics(data);
            if (opts.pushHistory) {
                state.history.push({ scenarioIndex: state.currentScenario, nodeId: data.id, at: nowISO() });
                state.lastActiveNodeId = data.id;
                // update ring buffer visual + persisted slots
                ringPushNodeRef({ scenarioIndex: state.currentScenario, nodeId: data.id });
            } else {
                state.lastActiveNodeId = data.id;
            }

            persistSession();

            if (state.viewMode !== 'map' && !opts.silentScroll) {
                try {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                } catch (_) { }
            }
        }

        function updateMetrics(node) {
            const txt = (node.label + " " + (node.meta || "") + " " + (node.monologue || "")).toLowerCase();
            const m = state.metrics;

            // crude but deterministic
            if (txt.includes("report") || txt.includes("purge") || txt.includes("incident")) { m.authority += 0.5; m.risk -= 0.2; }
            if (txt.includes("vent") || txt.includes("wipe") || txt.includes("containment")) { m.logic += 0.5; m.empathy -= 0.4; }
            if (txt.includes("hold") || txt.includes("patch") || txt.includes("latent")) { m.risk += 0.6; m.authority -= 0.3; }
            if (txt.includes("fail") || txt.includes("dead") || txt.includes("collapse") || txt.includes("threat")) { m.uncertainty += 0.8; }
            if (txt.includes("hero") || txt.includes("stabil")) { m.empathy += 0.3; m.logic += 0.1; }

            for (let k in m) m[k] = clamp(m[k], 0, 5);
            updateInstrument();
        }

        /* ------------------------------------------------------------------
           RING MEMORY (strict-ish: 12 slots, persist in LS)
           ------------------------------------------------------------------ */
        function renderRing() {
            const bar = document.getElementById('ring-bar');
            if (!bar) return;
            bar.innerHTML = '';

            // show only slots that have nodeRef, but keep spacing by rendering all 12
            state.ring.slots.forEach((slot) => {
                const dot = document.createElement('div');
                dot.className = 'ring-node';
                dot.title = slot.nodeRef ? `${slot.nodeRef.nodeId}` : 'empty';
                dot.dataset.slot = String(slot.index);
                if (slot.nodeRef && slot.nodeRef.nodeId === state.lastActiveNodeId) dot.classList.add('active');

                dot.onclick = () => {
                    if (!slot.nodeRef) { toast("EMPTY SLOT"); return; }
                    // jump scenario then node
                    const si = slot.nodeRef.scenarioIndex;
                    const nid = slot.nodeRef.nodeId;
                    loadScenario(si);
                    // defer activation after DOM is rebuilt
                    setTimeout(() => {
                        const nodeEl = document.getElementById(`node-${nid}`);
                        const data = lookupNodeById(nid);
                        if (nodeEl && data) {
                            activateNode(nodeEl, data, { pushHistory: false });
                            toast(`RESTORED ${nid}`);
                        } else {
                            toast("RESTORE FAIL");
                        }
                    }, 60);
                };

                // longpress: pin/unpin + clear
                attachLongPress(dot, () => openRingSlotMenu(slot.index));

                bar.appendChild(dot);
            });

            // scroll to end
            bar.scrollLeft = bar.scrollWidth;
        }

        function ringPushNodeRef(ref) {
            // policy: find first unpinned empty slot else oldest unpinned
            const slots = state.ring.slots;
            const now = nowISO();

            let idx = slots.findIndex(s => !s.pinned && !s.nodeRef);
            if (idx === -1) {
                // oldest unpinned
                let oldestAt = Infinity;
                slots.forEach((s, i) => {
                    if (s.pinned) return;
                    const t = s.updated_at ? Date.parse(s.updated_at) : 0;
                    if (t < oldestAt) { oldestAt = t; idx = i; }
                });
            }
            if (idx < 0) idx = 0;

            slots[idx].nodeRef = ref;
            slots[idx].updated_at = now;
            slots[idx].label = ref.nodeId;
            safeSaveJSON(LS.RING, state.ring);

            renderRing();
        }

        function openRingSlotMenu(slotIndex) {
            const slot = state.ring.slots[slotIndex];
            const has = !!slot.nodeRef;
            const pinned = !!slot.pinned;

            const action = prompt(
                `RING SLOT ${slotIndex}\n` +
                `${has ? "NODE: " + slot.nodeRef.nodeId : "EMPTY"}\n\n` +
                `Type one:\n` +
                `PIN  (toggle)\n` +
                `CLEAR\n` +
                `CANCEL`
            );
            if (!action) return;
            const cmd = action.trim().toUpperCase();

            if (cmd === "PIN") {
                slot.pinned = !slot.pinned;
                slot.updated_at = nowISO();
                safeSaveJSON(LS.RING, state.ring);
                renderRing();
                toast(slot.pinned ? "PINNED" : "UNPINNED");
                return;
            }

            if (cmd === "CLEAR") {
                slot.nodeRef = null;
                slot.label = null;
                slot.pinned = false;
                slot.updated_at = nowISO();
                safeSaveJSON(LS.RING, state.ring);
                renderRing();
                toast("CLEARED");
                return;
            }
        }

        function attachLongPress(el, onLong) {
            let t = null;
            const start = (e) => {
                if (e && e.type === "mousedown" && e.button !== 0) return;
                clearTimeout(t);
                t = setTimeout(() => { onLong(); }, 520);
            };
            const end = () => { clearTimeout(t); t = null; };
            el.addEventListener('touchstart', start, { passive: true });
            el.addEventListener('touchend', end);
            el.addEventListener('touchcancel', end);
            el.addEventListener('mousedown', start);
            el.addEventListener('mouseup', end);
            el.addEventListener('mouseleave', end);
        }

        /* ------------------------------------------------------------------
           INSTRUMENTS
           ------------------------------------------------------------------ */
        function updateInstrument() {
            const container = document.getElementById('genome-metrics');
            if (container) {
                container.innerHTML = METRICS.map(k => `
          <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.03); padding:8px; border-radius:4px;">
            <span style="color:var(--text-muted); font-size:9px; letter-spacing:1px; text-transform:uppercase;">${k.substring(0, 4)}</span>
            <div style="flex:1; height:4px; background:#333; margin:0 10px; border-radius:2px; overflow:hidden;">
              <div style="width:${(state.metrics[k] / 5) * 100}%; height:100%; background:var(--text);"></div>
            </div>
            <span style="font-weight:bold;">${state.metrics[k].toFixed(1)}</span>
          </div>
        `).join('');
            }
            drawRadar();
        }

        function drawRadar() {
            const canvas = document.getElementById('radar');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) return;

            canvas.width = Math.floor(rect.width * devicePixelRatio);
            canvas.height = Math.floor(rect.height * devicePixelRatio);
            ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);

            const cx = rect.width / 2;
            const cy = rect.height / 2;
            const r = Math.min(cx, cy) - 18;

            ctx.clearRect(0, 0, rect.width, rect.height);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = 1; i <= 4; i++) {
                ctx.beginPath();
                ctx.arc(cx, cy, r * (i / 4), 0, Math.PI * 2);
                ctx.stroke();
            }

            // axes
            const step = (Math.PI * 2) / METRICS.length;
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            METRICS.forEach((_, i) => {
                const ang = i * step - Math.PI / 2;
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(cx + Math.cos(ang) * r, cy + Math.sin(ang) * r);
                ctx.stroke();
            });

            // polygon
            ctx.beginPath();
            METRICS.forEach((k, i) => {
                const v = state.metrics[k] / 5;
                const ang = i * step - Math.PI / 2;
                const x = cx + Math.cos(ang) * (r * v);
                const y = cy + Math.sin(ang) * (r * v);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fillStyle = 'rgba(255, 61, 78, 0.2)';
            ctx.fill();
            ctx.strokeStyle = '#ff3d4e';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        /* ------------------------------------------------------------------
           LINES
           ------------------------------------------------------------------ */
        function drawLines() {
            const svg = document.getElementById('svg-layer');
            const wrapper = document.getElementById('viz-scale-wrapper');
            if (!svg || !wrapper) return;

            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.innerHTML = '';

            const wrapperRect = wrapper.getBoundingClientRect();
            const nodeWrappers = document.querySelectorAll('.node-wrapper');

            nodeWrappers.forEach(w => {
                const parent = w.children[0];
                const childrenRow = w.querySelector('.children-row');
                if (parent && childrenRow && !childrenRow.classList.contains('hidden')) {
                    const pRect = parent.getBoundingClientRect();
                    const pX = (pRect.left - wrapperRect.left + pRect.width / 2) / state.zoom;
                    const pY = (pRect.top - wrapperRect.top + pRect.height) / state.zoom;

                    Array.from(childrenRow.children).forEach(cw => {
                        const child = cw.children[0];
                        if (!child) return;
                        const cRect = child.getBoundingClientRect();
                        const cX = (cRect.left - wrapperRect.left + cRect.width / 2) / state.zoom;
                        const cY = (cRect.top - wrapperRect.top) / state.zoom;

                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const midY = pY + (cY - pY) / 2;
                        const d = `M ${pX} ${pY} C ${pX} ${midY}, ${cX} ${midY}, ${cX} ${cY}`;
                        path.setAttribute("d", d);
                        path.setAttribute("fill", "none");
                        path.setAttribute("stroke", "#333");
                        path.setAttribute("stroke-width", "2");
                        path.setAttribute("stroke-linecap", "round");
                        svg.appendChild(path);
                    });
                }
            });
        }

        /* ------------------------------------------------------------------
           TOUCH PAN & ZOOM + MOUSE DRAG PAN
           ------------------------------------------------------------------ */
        function setupTouchPanZoom() {
            const container = document.getElementById('viz-container');
            const wrapper = document.getElementById('viz-scale-wrapper');

            let initialDistance = 0;
            let initialZoom = 1;

            // pan state
            let isPanning = false;
            let startX = 0, startY = 0;
            let originPanX = 0, originPanY = 0;

            function applyTransform() {
                wrapper.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`;
                // semantic zoom
                if (state.zoom < 0.6) wrapper.classList.add('zoomed-out');
                else wrapper.classList.remove('zoomed-out');
            }

            // initialize transform
            applyTransform();

            // touch start
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    initialZoom = state.zoom;
                }
                if (e.touches.length === 1) {
                    isPanning = true;
                    startX = e.touches[0].pageX;
                    startY = e.touches[0].pageY;
                    originPanX = state.pan.x;
                    originPanY = state.pan.y;
                }
            }, { passive: false });

            container.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const delta = dist - initialDistance;
                    state.zoom = clamp(initialZoom + (delta * 0.005), 0.2, 2.5);
                    applyTransform();
                    e.preventDefault();
                    return;
                }

                if (e.touches.length === 1 && isPanning) {
                    const dx = e.touches[0].pageX - startX;
                    const dy = e.touches[0].pageY - startY;
                    state.pan.x = originPanX + dx;
                    state.pan.y = originPanY + dy;
                    applyTransform();
                    e.preventDefault();
                }
            }, { passive: false });

            container.addEventListener('touchend', () => {
                isPanning = false;
                persistSession();
                requestAnimationFrame(drawLines);
            });

            // mouse drag pan (desktop)
            container.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                isPanning = true;
                startX = e.pageX; startY = e.pageY;
                originPanX = state.pan.x; originPanY = state.pan.y;
            });
            window.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                const dx = e.pageX - startX;
                const dy = e.pageY - startY;
                state.pan.x = originPanX + dx;
                state.pan.y = originPanY + dy;
                applyTransform();
            });
            window.addEventListener('mouseup', () => {
                if (!isPanning) return;
                isPanning = false;
                persistSession();
                requestAnimationFrame(drawLines);
            });
        }

        /* ------------------------------------------------------------------
           CONTROLS & VIEWS
           ------------------------------------------------------------------ */
        const bind = (id, fn) => { const el = document.getElementById(id); if (el) el.onclick = fn; };

        function setupListeners() {
            const pSlider = document.getElementById('slider-proto');
            if (pSlider) pSlider.oninput = (e) => {
                state.mix.protocol = parseInt(e.target.value, 10);
                document.getElementById('val-proto').innerText = state.mix.protocol + "%";
                filterTree();
                persistSession();
            };
            const rSlider = document.getElementById('slider-risk');
            if (rSlider) rSlider.oninput = (e) => {
                state.mix.risk = parseInt(e.target.value, 10);
                document.getElementById('val-risk').innerText = state.mix.risk + "%";
                filterTree();
                persistSession();
            };

            bind('btn-play-desktop', () => toggleSim('btn-play-desktop'));
            bind('btn-reset-desktop', resetSim);
            bind('btn-play-mobile', () => toggleSim('btn-play-mobile'));
            bind('btn-reset-mobile', resetSim);

            bind('btn-manual', openManual);
            bind('manual-overlay', (e) => { if (e.target.id === 'manual-overlay') e.target.classList.remove('active'); });

            bind('btn-export', exportSession);
            bind('btn-import', () => document.getElementById('file-import').click());
            const fileInput = document.getElementById('file-import');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => importSessionFromFile(e.target.files?.[0]));
            }

            // Close panels on ESC
            window.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    closeAllPanels();
                    document.getElementById('manual-overlay')?.classList.remove('active');
                }
            });
        }

        function toggleSidebar(open = null) {
            const sb = document.getElementById('sidebar');
            const willOpen = (open === null) ? !sb.classList.contains('open') : open;
            sb.classList.toggle('open', willOpen);
            if (willOpen) document.getElementById('instrument-panel')?.classList.remove('open');
            updateScrim();
        }

        function toggleInstrument() {
            const p = document.getElementById('instrument-panel');
            const willOpen = !p.classList.contains('open');
            p.classList.toggle('open', willOpen);
            if (willOpen) document.getElementById('sidebar')?.classList.remove('open');
            updateScrim();
        }

        function toggleZenMode() {
            state.zenMode = !state.zenMode;
            document.body.classList.toggle('zen-mode', state.zenMode);
            persistSession();
            toast(state.zenMode ? "ZEN MODE" : "ZEN OFF");
        }

        // VIEW MODES
        function toggleViewMode() {
            const modes = ['focus', 'map', 'reader'];
            const currentIdx = modes.indexOf(state.viewMode);
            const next = modes[(currentIdx + 1) % modes.length];
            setViewMode(next);
        }

        function setViewMode(mode, opts = { silent: false }) {
            state.viewMode = mode;

            const btnText = document.getElementById('label-view-toggle');
            const viz = document.getElementById('viz-container');
            const reader = document.getElementById('reader-view');
            const wrapper = document.getElementById('viz-scale-wrapper');
            const zoomControls = document.getElementById('zoom-controls');
            const icon = document.getElementById('btn-view-toggle').querySelector('svg');

            viz.style.display = 'none';
            reader.style.display = 'none';
            zoomControls.style.display = 'flex';

            if (mode === 'focus') {
                btnText.innerText = 'FOCUS';
                viz.style.display = 'flex';
                icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
                if (state.zoom < 0.7) { /* don't force; focus is mode, not zoom */ }
            } else if (mode === 'map') {
                btnText.innerText = 'MAP';
                viz.style.display = 'flex';
                icon.innerHTML = '<path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>';
                // gently set zoom for map if user didn't already choose
                if (!opts.silent && state.zoom > 0.7) {
                    state.zoom = 0.45;
                    applyTransformOnly();
                }
            } else if (mode === 'reader') {
                btnText.innerText = 'READER';
                reader.style.display = 'flex';
                zoomControls.style.display = 'none';
                icon.innerHTML = '<path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/>';
            }

            persistSession();
            requestAnimationFrame(drawLines);

            function applyTransformOnly() {
                const w = document.getElementById('viz-scale-wrapper');
                w.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`;
                if (state.zoom < 0.6) w.classList.add('zoomed-out');
                else w.classList.remove('zoomed-out');
            }
        }

        function changeZoom(delta) {
            if (state.viewMode === 'reader') return;
            state.zoom = clamp(state.zoom + delta, 0.2, 2.5);

            const wrapper = document.getElementById('viz-scale-wrapper');
            wrapper.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`;

            if (state.zoom < 0.6) wrapper.classList.add('zoomed-out');
            else wrapper.classList.remove('zoomed-out');

            persistSession();
            setTimeout(drawLines, 60);
        }

        function filterTree() {
            const p = state.mix.protocol;
            const r = state.mix.risk;

            document.querySelectorAll('.tree-node').forEach(el => {
                const txt = (el.dataset.label || "").toUpperCase();
                let dim = false;

                // Protocol high dims "hold/patch" (human improvisation)
                if (p > 70 && (txt.includes("HOLD") || txt.includes("PATCH") || txt.includes("FALSIFY"))) dim = true;

                // Risk tolerance high dims "vent/purge" (sacrifice moves)
                if (r > 70 && (txt.includes("VENT") || txt.includes("PURGE") || txt.includes("WIPE"))) dim = true;

                dim ? el.classList.add('dimmed') : el.classList.remove('dimmed');
            });
        }

        function resetSim() {
            if (confirm("RESET SIMULATION?")) { loadScenario(state.currentScenario); toast("RESET"); }
        }

        function renderSidebar() {
            const list = document.getElementById('scenario-list');
            if (list) {
                list.innerHTML = SCENARIOS.map((s, i) => `
          <div class="list-item" data-index="${i}">
            <strong>${escapeHTML(s.title)}</strong>
            <div class="meta">${escapeHTML(s.root.meta || "")}</div>
          </div>
        `).join('');

                list.querySelectorAll('.list-item').forEach(el => {
                    el.addEventListener('click', () => {
                        const i = parseInt(el.dataset.index, 10);
                        loadScenario(i);
                        toast(`LOADED ${SCENARIOS[i].id}`);
                    });
                });
            }
        }

        /* ------------------------------------------------------------------
           SIMULATION ("GHOST")
           ------------------------------------------------------------------ */
        let simInterval;
        const toggleSim = (btnId) => {
            const btn = document.getElementById(btnId);

            if (state.simulating) {
                clearInterval(simInterval);
                state.simulating = false;
                if (btnId.includes('desktop')) btn.innerHTML = "‚ñ∂ GHOST";
                else btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>PLAY</span>`;
                toast("GHOST STOP");
                persistSession();
                return;
            }

            state.simulating = true;
            if (btnId.includes('desktop')) btn.innerHTML = "‚ùö‚ùö STOP";
            else btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg><span>STOP</span>`;
            toast("GHOST RUN");

            simInterval = setInterval(() => {
                const nodes = Array.from(document.querySelectorAll('.tree-node')).filter(n => !n.classList.contains('dimmed'));
                if (nodes.length === 0) return;
                const rand = nodes[Math.floor(Math.random() * nodes.length)];
                const nid = rand.id.replace('node-', '');
                const data = lookupNodeById(nid) || { id: nid, label: rand.dataset.label, meta: "GHOST", prob: 1.0, type: "root", branches: [] };
                activateNode(rand, data, { pushHistory: true });
            }, 1200);

            persistSession();
        };

        /* ------------------------------------------------------------------
           EXPORT / IMPORT (single-file session)
           ------------------------------------------------------------------ */
        function exportSession() {
            const payload = {
                schema_version: "v1",
                exported_at: nowISO(),
                currentScenario: state.currentScenario,
                zoom: state.zoom,
                pan: state.pan,
                viewMode: state.viewMode,
                mix: state.mix,
                metrics: state.metrics,
                lastActiveNodeId: state.lastActiveNodeId,
                ring: state.ring,
                history: state.history
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `fork_cascade_session_${SCENARIOS[state.currentScenario].id}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            toast("EXPORTED");
        }

        async function importSessionFromFile(file) {
            if (!file) return;
            try {
                const text = await file.text();
                const obj = JSON.parse(text);
                if (!obj || obj.schema_version !== "v1") throw new Error("Bad schema_version");

                if (typeof obj.currentScenario === "number") state.currentScenario = clamp(obj.currentScenario, 0, SCENARIOS.length - 1);
                if (obj.zoom) state.zoom = clamp(obj.zoom, 0.2, 2.5);
                if (obj.pan && typeof obj.pan.x === "number" && typeof obj.pan.y === "number") state.pan = { x: obj.pan.x, y: obj.pan.y };
                if (obj.viewMode) state.viewMode = obj.viewMode;
                if (obj.mix) state.mix = { protocol: clamp(obj.mix.protocol ?? 50, 0, 100), risk: clamp(obj.mix.risk ?? 50, 0, 100) };
                if (obj.metrics) state.metrics = Object.fromEntries(METRICS.map(k => [k, clamp(obj.metrics[k] ?? 2.5, 0, 5)]));
                if (obj.ring) state.ring = obj.ring;
                if (obj.lastActiveNodeId) state.lastActiveNodeId = obj.lastActiveNodeId;

                safeSaveJSON(LS.RING, state.ring);
                persistSession();

                loadScenario(state.currentScenario);

                // apply pan+zoom to wrapper
                const w = document.getElementById('viz-scale-wrapper');
                w.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`;
                if (state.zoom < 0.6) w.classList.add('zoomed-out');
                else w.classList.remove('zoomed-out');

                toast("IMPORTED");
            } catch (e) {
                console.error(e);
                toast("IMPORT FAIL", 1600);
            }
        }

        /* ------------------------------------------------------------------
           MANUAL
           ------------------------------------------------------------------ */
        function openManual() {
            const ov = document.getElementById('manual-overlay');
            const content = document.getElementById('manual-content');
            ov.classList.add('active');

            const scn = currentScenario();
            content.innerHTML = `
        <div style="padding:40px; color:#000;">
          <h1 style="font-size:20px; font-weight:900; border-bottom:4px solid #000; padding-bottom:10px;">PRACTITIONER RECORD</h1>
          <div style="margin-top:10px; color:#111; opacity:.8;">
            <div><b>SYSTEM</b>: ${escapeHTML(scn.id)} ‚Äî ${escapeHTML(scn.title)}</div>
            <div style="margin-top:6px;"><b>VECTOR</b>: ${escapeHTML(state.lastActiveNodeId || scn.root.id)}</div>
          </div>

          <div style="margin-top:22px;">
            ${METRICS.map(k => `
              <div style="display:flex;justify-content:space-between;border-bottom:1px dotted #ccc;padding:8px 0;">
                <span>${k.toUpperCase()}</span>
                <b>${state.metrics[k].toFixed(1)}</b>
              </div>
            `).join('')}
          </div>

          <div style="margin-top:22px; border-top:2px solid #000; padding-top:18px;">
            <div style="font-weight:800;">MIX</div>
            <div style="margin-top:8px; display:flex; justify-content:space-between;">
              <span>PROTOCOL RIGIDITY</span><b>${state.mix.protocol}%</b>
            </div>
            <div style="margin-top:8px; display:flex; justify-content:space-between;">
              <span>HUMAN COST TOLERANCE</span><b>${state.mix.risk}%</b>
            </div>
          </div>

          <button onclick="document.getElementById('manual-overlay').classList.remove('active')"
                  style="width:100%; padding:15px; margin-top:30px; background:#000; color:#fff; border:none; font-weight:bold; cursor:pointer;">
            CLOSE
          </button>
        </div>
      `;
        }

        /* ------------------------------------------------------------------
           OVERLAY UTILITIES
           ------------------------------------------------------------------ */
        function closeOverlay(id) {
            document.getElementById(id)?.classList.remove('active');
            logTelemetry('overlay_close', { overlay: id });
        }

        function openOverlay(id) {
            document.getElementById(id)?.classList.add('active');
            logTelemetry('overlay_open', { overlay: id });
        }

        /* ------------------------------------------------------------------
           RING MEMORY OVERLAY (12 slots)
           ------------------------------------------------------------------ */
        function renderRingOverlay() {
            const container = document.getElementById('ring-slots');
            if (!container) return;
            container.innerHTML = '';

            state.ring.slots.forEach((slot, i) => {
                const div = document.createElement('div');
                div.style.cssText = 'background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;cursor:pointer;min-height:60px;';
                if (slot.pinned) div.style.borderColor = 'var(--accent)';

                if (slot.snapshotId) {
                    div.innerHTML = `<div style="font-size:10px;color:var(--accent);">${slot.label || 'SLOT ' + i}</div><div style="font-size:8px;color:var(--text-muted);margin-top:4px;">${slot.pinned ? 'üìå' : ''}</div>`;
                    div.onclick = () => { restoreSnapshot(slot.snapshotId); closeOverlay('ring-overlay'); };
                } else {
                    div.innerHTML = `<div style="font-size:10px;color:var(--text-muted);">EMPTY</div><div style="font-size:8px;margin-top:4px;">${i}</div>`;
                }

                // Long-press for menu
                attachLongPress(div, () => openRingSlotMenu(i));
                container.appendChild(div);
            });
        }

        function assignToRingSlot(snapshotId, slotIndex) {
            const snap = state.snapshots.find(s => s.id === snapshotId);
            state.ring.slots[slotIndex] = {
                index: slotIndex,
                snapshotId: snapshotId,
                label: snap?.scenario_title || 'SNAP',
                pinned: false,
                updated_at: nowISO()
            };
            safeSaveJSON(LS.RING, state.ring);
            renderRing();
            renderRingOverlay();
            toast('ASSIGNED TO SLOT ' + slotIndex);
            logTelemetry('ring_assign', { slotIndex, snapshotId });
        }

        function openRingOverlay() {
            renderRingOverlay();
            openOverlay('ring-overlay');
        }

        /* ------------------------------------------------------------------
           SNAPSHOTS OVERLAY (max 20)
           ------------------------------------------------------------------ */
        function saveSnapshot(note = '', auto = false) {
            const snap = {
                id: 'SHOT_' + Math.random().toString(16).slice(2, 10).toUpperCase(),
                at: nowISO(),
                scenario_id: currentScenario()?.id || null,
                scenario_title: currentScenario()?.title || null,
                selectedNodeId: state.lastActiveNodeId,
                mixState: { ...state.mix },
                showThick: false,
                simActive: state.simulating,
                simSpeed: 1200,
                testMode: false,
                genome: { ...state.metrics },
                note: note,
                auto: auto
            };

            state.snapshots.unshift(snap);
            if (state.snapshots.length > 20) state.snapshots.pop();

            safeSaveJSON(LS.SNAP, state.snapshots);
            renderSnapshotsOverlay();
            toast('SNAPSHOT SAVED');
            logTelemetry('snapshot_save', { id: snap.id, auto });
        }

        function restoreSnapshot(id) {
            const snap = state.snapshots.find(s => s.id === id);
            if (!snap) { toast('SNAPSHOT NOT FOUND'); return; }

            // Find scenario index
            const idx = SCENARIOS.findIndex(s => s.id === snap.scenario_id);
            if (idx >= 0) {
                state.currentScenario = idx;
                state.mix = { ...snap.mixState };
                state.metrics = { ...snap.genome };
                loadScenario(idx);

                // Restore selected node
                if (snap.selectedNodeId) {
                    setTimeout(() => {
                        const el = document.getElementById('node-' + snap.selectedNodeId);
                        const data = lookupNodeById(snap.selectedNodeId);
                        if (el && data) activateNode(el, data, { pushHistory: false });
                    }, 100);
                }
            }

            toast('RESTORED ' + snap.id);
            logTelemetry('snapshot_restore', { id });
        }

        function deleteSnapshot(id) {
            state.snapshots = state.snapshots.filter(s => s.id !== id);
            safeSaveJSON(LS.SNAP, state.snapshots);
            renderSnapshotsOverlay();
            toast('DELETED');
            logTelemetry('snapshot_delete', { id });
        }

        function renderSnapshotsOverlay() {
            const container = document.getElementById('snapshots-list');
            if (!container) return;

            if (state.snapshots.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">No snapshots yet</div>';
                return;
            }

            container.innerHTML = state.snapshots.map(s => `
                <div style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div>
                            <div style="font-weight:bold;font-size:11px;color:var(--accent);">${escapeHTML(s.id)}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">${escapeHTML(s.scenario_title || '‚Äî')} ¬∑ ${s.at?.slice(0, 10) || ''}</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn" style="padding:6px 10px;font-size:9px;" onclick="restoreSnapshot('${s.id}');closeOverlay('snapshots-overlay');">RESTORE</button>
                            <button class="btn" style="padding:6px 10px;font-size:9px;color:var(--trackB);" onclick="deleteSnapshot('${s.id}')">‚úï</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openSnapshotsOverlay() {
            renderSnapshotsOverlay();
            openOverlay('snapshots-overlay');
        }

        /* ------------------------------------------------------------------
           KEYSTORE OVERLAY
           ------------------------------------------------------------------ */
        function createKey() {
            const name = document.getElementById('key-name')?.value?.trim();
            const value = document.getElementById('key-value')?.value || '';

            if (!name || !/^[a-zA-Z0-9._-]{1,64}$/.test(name)) {
                toast('Invalid key name'); return;
            }
            if (value.length > 4096) {
                toast('Value too long (max 4KB)'); return;
            }

            const entry = {
                id: 'KEY_' + Math.random().toString(16).slice(2, 10).toUpperCase(),
                scope: 'global',
                name: name,
                value: value,
                created_at: nowISO(),
                updated_at: nowISO()
            };

            state.keyStore.keys.push(entry);
            safeSaveJSON('LEGOS_TETRAD_KEYS_v1', state.keyStore);
            renderKeysOverlay();
            document.getElementById('key-name').value = '';
            document.getElementById('key-value').value = '';
            toast('KEY CREATED');
            logTelemetry('key_create', { id: entry.id, name });
        }

        function deleteKey(id) {
            state.keyStore.keys = state.keyStore.keys.filter(k => k.id !== id);
            safeSaveJSON('LEGOS_TETRAD_KEYS_v1', state.keyStore);
            renderKeysOverlay();
            toast('KEY DELETED');
            logTelemetry('key_delete', { id });
        }

        function renderKeysOverlay() {
            const container = document.getElementById('keys-list');
            if (!container) return;

            if (state.keyStore.keys.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">No keys stored</div>';
                return;
            }

            container.innerHTML = state.keyStore.keys.map(k => `
                <div style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-weight:bold;font-size:11px;color:var(--trackA);">${escapeHTML(k.name)}</div>
                        <button class="btn" style="padding:4px 8px;font-size:9px;" onclick="deleteKey('${k.id}')">‚úï</button>
                    </div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:6px;word-break:break-all;">${escapeHTML(k.value.slice(0, 100))}${k.value.length > 100 ? '...' : ''}</div>
                </div>
            `).join('');
        }

        function openKeysOverlay() {
            renderKeysOverlay();
            openOverlay('keys-overlay');
        }

        /* ------------------------------------------------------------------
           TETRAD PERSPECTIVE OVERLAY
           ------------------------------------------------------------------ */
        function selectLens(lens) {
            state.tetradState.activeLens = lens;
            document.getElementById('current-lens').textContent = 'CURRENT: ' + lens.toUpperCase();
            document.querySelectorAll('.tetrad-btn').forEach(btn => {
                btn.style.borderColor = btn.dataset.lens === lens ? 'var(--accent)' : 'var(--border-light)';
            });
            persistSession();
            logTelemetry('tetrad_lens_select', { lens });
        }

        function openTetradOverlay() {
            document.getElementById('current-lens').textContent = 'CURRENT: ' + state.tetradState.activeLens.toUpperCase();
            document.querySelectorAll('.tetrad-btn').forEach(btn => {
                btn.style.borderColor = btn.dataset.lens === state.tetradState.activeLens ? 'var(--accent)' : 'var(--border-light)';
            });
            openOverlay('tetrad-overlay');
        }

        /* ------------------------------------------------------------------
           GRID SECTION (3x3 macro view)
           ------------------------------------------------------------------ */
        function renderGridOverlay() {
            const container = document.getElementById('grid-section');
            if (!container) return;
            container.innerHTML = '';

            for (let y = 0; y < 3; y++) {
                for (let x = 0; x < 3; x++) {
                    const binding = state.gridState.bindings.find(b => b.cell.x === x && b.cell.y === y);
                    const div = document.createElement('div');
                    div.style.cssText = 'background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center;cursor:pointer;min-height:80px;display:flex;flex-direction:column;justify-content:center;';

                    if (binding) {
                        div.style.borderColor = 'var(--accent)';
                        div.innerHTML = `<div style="font-size:10px;color:var(--accent);font-weight:bold;">${escapeHTML(binding.label || binding.nodeId)}</div><div style="font-size:8px;color:var(--text-muted);margin-top:4px;">${binding.tetradLens || ''}</div>`;
                        div.onclick = () => jumpToGridBinding(binding);
                        attachLongPress(div, () => unbindGridCell(x, y));
                    } else {
                        div.innerHTML = `<div style="font-size:10px;color:var(--text-muted);">[${x},${y}]</div>`;
                        div.onclick = () => bindGridCell(x, y);
                    }

                    container.appendChild(div);
                }
            }
        }

        function bindGridCell(x, y) {
            if (!state.lastActiveNodeId) { toast('SELECT A NODE FIRST'); return; }

            const node = lookupNodeById(state.lastActiveNodeId);
            const binding = {
                cell: { x, y },
                channelId: currentScenario()?.id,
                nodeId: state.lastActiveNodeId,
                tetradLens: state.tetradState.activeLens,
                label: node?.label || state.lastActiveNodeId,
                created_at: nowISO()
            };

            state.gridState.bindings = state.gridState.bindings.filter(b => !(b.cell.x === x && b.cell.y === y));
            state.gridState.bindings.push(binding);
            persistSession();
            renderGridOverlay();
            toast('BOUND TO [' + x + ',' + y + ']');
            logTelemetry('grid_bind', { cell: { x, y }, nodeId: binding.nodeId });
        }

        function unbindGridCell(x, y) {
            state.gridState.bindings = state.gridState.bindings.filter(b => !(b.cell.x === x && b.cell.y === y));
            persistSession();
            renderGridOverlay();
            toast('UNBOUND [' + x + ',' + y + ']');
            logTelemetry('grid_unbind', { cell: { x, y } });
        }

        function jumpToGridBinding(binding) {
            const idx = SCENARIOS.findIndex(s => s.id === binding.channelId);
            if (idx >= 0) {
                loadScenario(idx);
                if (binding.tetradLens) selectLens(binding.tetradLens);

                setTimeout(() => {
                    const el = document.getElementById('node-' + binding.nodeId);
                    const data = lookupNodeById(binding.nodeId);
                    if (el && data) activateNode(el, data, { pushHistory: true });
                }, 100);
            }
            closeOverlay('grid-overlay');
        }

        function openGridOverlay() {
            renderGridOverlay();
            openOverlay('grid-overlay');
        }

        /* ------------------------------------------------------------------
           TELEMETRY (strict per spec)
           ------------------------------------------------------------------ */
        function logTelemetry(event, context = {}) {
            const payload = {
                at: nowISO(),
                session_id: state.sessionId || 'anon',
                event: event,
                context: {
                    channelId: currentScenario()?.id,
                    nodeId: state.lastActiveNodeId,
                    lens: state.tetradState?.activeLens,
                    mixState: state.mix,
                    ...context
                }
            };
            console.log('[TELEMETRY]', payload);
            // Could send to analytics endpoint here
        }

        /* ------------------------------------------------------------------
           SECURITY: tiny HTML escape for injected fields
           ------------------------------------------------------------------ */
        function escapeHTML(str) {
            return String(str ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        /* ------------------------------------------------------------------
           BOOT
           ------------------------------------------------------------------ */
        init();
    </script>
</body>

</html>